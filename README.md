# Quizli
API-сервис для вопросов и ответов

# Стек
`Fastapi, PostgreSQL, Docker, Alembic, SQLAlchemy`

# Инструкция по установке и использованию разработанного функционала приложения
1. Клонируйте репозиторий:
```
git clone https://github.com/4usnok/Quizli.git
```
2. Активируйте виртуальное окружение poetry:
```
poetry shell
```
3. Установите зависимости poetry:
```
poetry install
```

# Управление приложением  
Запуск -> `uvicorn main:app --reload`

# Содержание проекта
## Директория app
Предназначена для компонентов приложения:
1. `models` -> Pydantic модели:  
1.1. `answer.py` -> модели для ответов  
1.2. `question.py` -> модели для вопросов  
  
2. `schemas` -> SQLAlchemy модели:  
2.1. `answer.py` -> модели для ответов  
2.2. `question.py` -> модели для вопросов  
  
3. `services` -> бизнес логика:  
3.1. `answer_service.py` -> проверка, что вопрос существует
  
4. `core` -> инфраструктура приложения:  
4.1. `config.py` -> Настройка БД  
  
5. `crud` -> CRUD-логика  
5.1. `answer.py` -> CRUD для ответов  
5.2. `question.py` -> CRUD для вопросов  
  
6. `routers` -> API эндпоинты/роутеры:  
6.1. `answer.py` -> api ответов  
6.2. `question.py` -> api вопросов  
  
7. `tests` -> тесты:  
7.1. `test_question_crud.py` -> тесты для вопросов  
7.2. `test_answer_crud.py` -> тесты для ответов

## Прочие файлы файлы
1. `.env.sample` -> шаблон файла `.env` (заполняется в первую очередь)  
2. `.flake8` -> настройки для линтера `flake8`  
3. `.gitignore` -> текстовый файл позволяет контролировать, что следует игнорировать и не отслеживать  
4. `alembic.ini` -> настройки `alembic`  
5. `main.py` -> главный файл для запуска приложения  
6. `docker-compose.yml` -> оркестрация нескольких сервисов  
7. `Dockerfile` -> инструкция по сборке образа  
8. `nginx` -> директория с файлами для корректной настройки `nginx`  

## Инструкции по настройке удаленного сервера и деплоя  

# Создание и настройка виртуальной машины и сервера  

Шаг 1. Создание виртуальной машины и обновление системы:  
1. Создание ВМ происходит на Yandex Cloud по адресу:  
`console.yandex.cloud/`  
2. Подключение к ВМ:  
`ssh -l kilyaka 10.130.0.30`  

Шаг 2. Перед подключением к ВМ, необходимо убедиться, что все пакеты имеют актуальные версии, 
а система имеет рабочее состояние  
1. Команда для обновления списка пакетов:  
`sudo apt update`  
2. Команда для обновления всех установленных пакетов до их последних версий:  
`sudo apt upgrade`  

Шаг 3. Установка Докера состоит из последовательности команд, которые можно найти по ссылке в документации:  
https://docs.docker.com/engine/install/ubuntu/  

Шаг 4. Настройка файрвола  
1. Сначала проверьте состояние файрвола с помощью команды:  
`sudo ufw status`  
Если файрвол отключен, активируйте его:  
`sudo ufw enable`  
2. Теперь откройте необходимые порты:  
Порт 80 для HTTP:  
`sudo ufw allow 80/tcp`  
Порт 443 для HTTPS:  
`sudo ufw allow 443/tcp`  
3. Порт 22.  
Чтобы обеспечить доступ к вашему серверу по SSH, необходимо не забыть открыть порт 22. 
Открытие порта 22:  
`sudo ufw allow 22/tcp`  

Шаг 5. Проверьте настройки файрвола.  
После добавления портов, проверьте состояние файрвола снова, чтобы убедиться, что порт 22 также открыт:  
`sudo ufw status`  

Ожидаемый результат:  
В результате выполнения команды вы должны увидеть, что порт 22 находится в состоянии ALLOW наряду с портами 80 и 443. 
Это означает, что ваш сервер будет доступен для SSH-подключений, а также для веб-трафика.  

Теперь ваш сервер безопасен и доступен для управления через SSH, а также для обработки HTTP и HTTPS запросов.  

# Ручной деплой приложения  

Ручной деплой состоит из нескольких шагов:  

Шаг 1. Подключение к ВМ 
В `Bash` или `Powershell` необходимо ввести команду:  
`ssh -l kilyaka 10.130.0.30`  

Шаг 2. Теперь нужно склонировать репозиторий и перейти в папку с проектом  
Клонирование репозитория:  
команда -> `git clone https://github.com/4usnok/Quizli.git`  
Переход в папку с проектом:  
команда -> `cd Quizli`


Шаг 3. Права доступа  
Настройка прав пользователя иногда может потребоваться и она состоит из следующих шагов:  
1. Добавьте пользователя в группу docker:  
`sudo usermod -aG docker $USER`  
2. Применить изменения групп (выйдите и войдите заново, или выполните):  
`newgrp docker`  
3. Проверить, что пользователь добавлен в группу docker:  
`groups`  
4. Проверить работу Docker:  
`docker ps`  

Шаг 4. Проверка и подгрузка недостающих файлов:  
Выполните команду для проверки доступных файлов:  
1. После того, как мы склонировали проект, необходимо зайти в его корневую директорию:  
`cd develop`  
2. Проверить наличие веток:  
`git branch -r`  
3. Подгрузка недостающих файлов:  
Баш может не найти нужные для деплоя файлы или же, в процессе разработки, можем добавить новый функционал. 
В этом случае, необходимо будет обратиться на удалённый репозиторий:  
команда для подгрузки: `git pull origin develop`  
проверка файлов на ветке: `git ls-tree -r origin/develop`, где ветка develop ветка разработки  
`origin` -> это для удалённых веток, поэтому необходимо оставить  
4. Переключение на ветку:  
`git checkout develop`  
5. Также перед запуском сборки нужно не забыть заполнить env и установить docker-compose:  
5.1. Заполнение `.env` происходит через -> `nano .env`  
5.2. Установка docker-compose -> `sudo apt install docker-compose`  

Шаг 5. После того, как мы настроили сервер и склонировали проект, запускаем сборку контейнера и деплой:
`docker-compose up -d`

# Полезные команды
1. Создание миграций -> `alembic revision --autogenerate -m "Create Quizli Table"`
2. Применение миграций -> `alembic upgrade head`
3. Создания файла с покрытием .coverage -> `coverage html `
4. Посмотреть покрытие unit-тестами -> `coverage report`
5. Тестирование приложения -> `python -m unittest -v`
